<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
    <title>æ”’é’±å°åŠ©æ‰‹ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* === 1. åŸºç¡€å˜é‡ === */
        :root {
            --primary: #059669;
            --primary-bg: #d1fae5;
            --accent: #fbbf24;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --radius: 16px;
            --shadow: 0 2px 8px -1px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] {
            --primary: #34d399;
            --primary-bg: #064e3b;
            --bg: #000000; /* çº¯é»‘çœç”µ */
            --card-bg: #1c1c1e;
            --text-main: #f2f2f7;
            --text-sub: #8e8e93;
            --border: #2c2c2e;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* === 2. å…¨å±€å¸ƒå±€ (Mobile First) === */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            /* é€‚é… iPhone åº•éƒ¨é»‘æ¡å’Œé¡¶éƒ¨åˆ˜æµ· */
            padding: max(12px, env(safe-area-inset-top)) 16px max(30px, env(safe-area-inset-bottom)) 16px;
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }

        .app { max-width: 1000px; margin: 0 auto; position: relative; }

        /* æ‚¬æµ®æŒ‰é’® */
        .theme-toggle-btn {
            position: absolute; top: 0; right: 0;
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--card-bg); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; box-shadow: var(--shadow); cursor: pointer; z-index: 10;
        }

        .header { text-align: center; margin-bottom: 20px; padding-top: 10px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 1.5rem; letter-spacing: -0.5px; }
        .subtitle { font-size: 0.8rem; color: var(--text-sub); opacity: 0.8; }

        /* æ ¸å¿ƒç½‘æ ¼ - æ‰‹æœºä¸Šæ˜¯å•åˆ—å‚ç›´å †å  */
        .dashboard-grid { display: flex; flex-direction: column; gap: 16px; }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .panel {
            background: var(--card-bg); border-radius: var(--radius); padding: 20px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .panel h2 { 
            margin: 0 0 15px 0; font-size: 1rem; color: var(--text-sub); 
            border-bottom: 1px solid var(--border); padding-bottom: 8px; font-weight: 600; 
        }

        /* === 3. é’ˆå¯¹æ‰‹æœºä¼˜åŒ–çš„æ¨¡å— === */

        /* A. é¡¶éƒ¨è¿›åº¦å¡ç‰‡ */
        .area-progress { 
            background: linear-gradient(135deg, #059669 0%, #047857 100%); 
            color: white; border: none;
        }
        .area-progress h2 { color: rgba(255,255,255,0.8); border-color: rgba(255,255,255,0.2); }

        /* é‡ç‚¹ï¼šæ‰‹æœºä¸Šæ”¹æˆ 2x2 ç½‘æ ¼ï¼Œè§£å†³æ•°å­—é‡å é—®é¢˜ */
        .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .stats span { display: block; font-size: 0.75rem; opacity: 0.8; margin-bottom: 2px; }
        .stats strong { display: block; font-size: 1.4rem; font-weight: 700; line-height: 1.1; }

        .bar { background: rgba(255,255,255,0.2); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 15px; }
        .bar-fill { background: var(--accent); height: 100%; width: 0%; transition: width 0.5s; }
        .emoji-track { height: 24px; position: relative; margin-bottom: 5px; }
        .mascot { position: absolute; font-size: 20px; transition: left 0.5s; bottom: 0; transform: translateX(-50%); }

        /* B. è®°ä¸€ç¬” (è¾“å…¥æ¡†) */
        /* é‡ç‚¹ï¼šæ‰‹æœºä¸Šæ”¹ä¸ºå‚ç›´æ’åˆ—ï¼ŒæŒ‰é’®å…¨å®½ï¼Œæ›´å¥½æŒ‰ */
        .deposit-row { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .deposit-row input { 
            padding: 12px; font-size: 1.2rem; font-weight: bold; color: var(--primary); 
            border-radius: 12px; text-align: center;
        }
        
        button { 
            padding: 12px; border-radius: 12px; border: none; 
            background: var(--primary); color: white; font-weight: 600; font-size: 1rem;
            width: 100%; cursor: pointer;
        }
        button:active { transform: scale(0.98); opacity: 0.9; }
        button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }

        /* C. è®¾ç½®è¡¨å• */
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-form > div { grid-column: span 2; } /* é»˜è®¤å æ»¡ä¸€è¡Œ */
        /* æ—¥æœŸé€‰æ‹©å™¨è®©å®ƒå¹¶æ’ï¼ŒèŠ‚çœç©ºé—´ */
        .grid-form > div:nth-child(2), .grid-form > div:nth-child(3) { grid-column: span 1; }

        label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 4px; }
        input, select { 
            width: 100%; padding: 10px; border: 1px solid var(--border); 
            background: var(--bg); color: var(--text-main); border-radius: 10px; 
            box-sizing: border-box; font-size: 1rem;
            -webkit-appearance: none; /* ç§»é™¤iOSé»˜è®¤æ ·å¼ */
        }

        /* D. åˆ—è¡¨ä¼˜åŒ– */
        .list { list-style: none; padding: 0; margin: 0; }
        .list li { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 0.95rem;
        }
        .list li:last-child { border-bottom: none; }

        /* === 4. ç”µè„‘/å¹³æ¿ç«¯é€‚é… (Media Queries) === */
        /* å½“å±å¹•å®½åº¦å¤§äº 768px æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºå®½å±å¸ƒå±€ */
        @media (min-width: 768px) {
            body { padding: 20px; }
            .dashboard-grid { 
                display: grid; 
                grid-template-columns: repeat(12, 1fr); 
                gap: 20px; 
            }
            
            /* æ¢å¤æ¨ªå‘ç»Ÿè®¡ */
            .stats { display: flex; gap: 0; text-align: center; }
            .stats strong { font-size: 1.8rem; }
            
            /* æ¢å¤æ¨ªå‘æŒ‰é’® */
            .deposit-row { flex-direction: row; }
            .deposit-row input { text-align: left; }
            button { width: auto; padding: 10px 20px; }

            /* å¡ç‰‡å¸ƒå±€åˆ†é… */
            .area-progress { grid-column: span 12; }
            .area-deposit { grid-column: span 4; }
            .area-chart { grid-column: span 8; }
            .area-config { grid-column: span 6; }
            .area-goals { grid-column: span 6; }
            .area-cloud { grid-column: span 12; }
            
            /* è¡¨å•å˜å›å•åˆ— */
            .grid-form > div { grid-column: span 1; }
        }

        .calc-hint { font-size: 0.8rem; color: var(--primary); background: var(--primary-bg); padding: 8px; border-radius: 6px; margin-top:10px; display:none; }
        .footer { text-align: center; font-size: 0.75rem; color: var(--text-sub); margin-top: 30px; opacity: 0.6; }
    </style>
</head>
<body>

<div class="app">
    <button class="theme-toggle-btn" id="themeToggleBtn">ğŸŒ</button>

    <header class="header">
        <h1>ğŸ’° æ”’é’±å°åŠ©æ‰‹ Pro</h1>
        <div class="subtitle">è‡ªé€‚åº”å¸ƒå±€ V3.1</div>
    </header>

    <div class="dashboard-grid">
        <section class="panel area-progress">
            <h2>å½“å‰è¿›åº¦</h2>
            <div class="stats">
                <div><span>å·²å­˜æ€»é¢</span><strong id="savedTotal">Â¥0</strong></div>
                <div><span>ç›®æ ‡é‡‘é¢</span><strong id="targetTotal">Â¥0</strong></div>
                <div><span>å®Œæˆç‡</span><strong id="percent">0%</strong></div>
                <div><span>è·ç¦»ç›®æ ‡</span><strong id="remain">Â¥0</strong></div>
            </div>
            <div class="emoji-track"><div class="mascot" id="mascot">ğŸš²</div></div>
            <div class="bar"><div class="bar-fill" id="barFill"></div></div>
            <div style="text-align: center; font-size: 0.9rem; opacity: 0.9;" id="motivate">åŠ è½½ä¸­...</div>
        </section>

        <section class="panel area-deposit">
            <h2>ğŸ“ è®°ä¸€ç¬”</h2>
            <div class="deposit-row">
                <input type="number" id="depositAmount" placeholder="è¾“å…¥é‡‘é¢" inputmode="decimal"/>
                <button id="addDeposit">å­˜å…¥</button>
            </div>
            <h3>æœ€è¿‘è®°å½•</h3>
            <ul class="list" id="logList"></ul>
        </section>

        <section class="panel area-chart">
            <h2>ğŸ“ˆ è´¢å¯Œæ›²çº¿</h2>
            <div style="height: 200px;"><canvas id="growthChart"></canvas></div>
        </section>

        <section class="panel area-config">
            <h2>âš™ï¸ è®¡åˆ’è®¾ç½®</h2>
            <div class="grid-form">
                <div><label>æ¯æ—¥å­˜å…¥ (å…ƒ)</label><input type="number" id="dailyAmount" inputmode="decimal"/></div>
                <div><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="startDate" /></div>
                <div><label>æˆªæ­¢æ—¥æœŸ</label><input type="date" id="endDate" /></div>
                <div><label>æ€»ç›®æ ‡ (è‡ªåŠ¨ç®—)</label><input type="number" id="targetAmount" inputmode="decimal"/></div>
                <div><label>ä¸»é¢˜é£æ ¼</label>
                    <select id="theme">
                        <option value="travel">âœˆï¸ æ—…è¡Œ</option>
                        <option value="house">ğŸ  ä¹°æˆ¿</option>
                        <option value="digital">ğŸ’» æ•°ç </option>
                    </select>
                </div>
            </div>
            <div id="calcHint" class="calc-hint"></div>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button id="saveConfig">ä¿å­˜è®¾ç½®</button>
                <button id="resetAll" class="secondary" style="color:var(--text-sub)">é‡ç½®</button>
            </div>
        </section>

        <section class="panel area-goals">
            <h2>ğŸ¯ æ„¿æœ›æ¸…å•</h2>
            <div class="deposit-row">
                <input id="goalName" placeholder="æ„¿æœ›åç§°" />
                <input id="goalTarget" type="number" placeholder="é‡‘é¢" inputmode="decimal" />
                <button id="addGoalBtn" class="secondary">æ·»åŠ </button>
            </div>
            <ul class="list" id="goalsList"></ul>
        </section>
    </div>

    <footer class="footer">æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° LocalStorage</footer>
</div>

<script>
    // === é€»è¾‘éƒ¨åˆ† (ä¿æŒ V3 åŠŸèƒ½ä¸å˜) ===
    const APP_KEY = 'money_tracker_v3';
    const OLD_KEY = 'saver.v3';
    const THEME_KEY = 'money_tracker_theme';

    let appData = {
        config: { daily: 50, target: 10000, start: new Date().toISOString().slice(0,10), end: '', theme: 'travel' },
        logs: [], goals: []
    };
    let chartInstance = null;

    document.addEventListener('DOMContentLoaded', () => {
        tryMigrateData(); loadData(); initTheme(); renderAll(); setupEvents();
    });

    function tryMigrateData() {
        if (localStorage.getItem(APP_KEY)) return;
        const oldRaw = localStorage.getItem(OLD_KEY);
        if (oldRaw) {
            try {
                const old = JSON.parse(oldRaw);
                if (old.entries) appData.logs = old.entries.map(e => ({ amount: e.amount, timestamp: new Date(e.t).getTime() }));
                if (old.goals && old.goals[0]) {
                    appData.config.target = old.goals[0].target;
                    appData.config.start = old.goals[0].start ? old.goals[0].start.slice(0,10) : '';
                }
                saveData();
            } catch(e){}
        }
    }

    function loadData() {
        const saved = localStorage.getItem(APP_KEY);
        if (saved) appData = { ...appData, ...JSON.parse(saved) };
        updateInputs();
    }

    function updateInputs(){
        document.getElementById('dailyAmount').value = appData.config.daily;
        document.getElementById('targetAmount').value = appData.config.target;
        document.getElementById('startDate').value = appData.config.start;
        document.getElementById('endDate').value = appData.config.end;
        document.getElementById('theme').value = appData.config.theme;
    }

    function saveData() {
        localStorage.setItem(APP_KEY, JSON.stringify(appData));
        renderAll();
    }

    function renderAll() {
        const total = appData.logs.reduce((sum, item) => sum + Number(item.amount), 0);
        const target = Number(appData.config.target) || 10000;
        const pct = Math.min(100, Math.round((total / target) * 100));
        const remain = Math.max(0, target - total);

        document.getElementById('savedTotal').innerText = `Â¥${total.toLocaleString()}`;
        document.getElementById('targetTotal').innerText = `Â¥${target.toLocaleString()}`;
        document.getElementById('percent').innerText = `${pct}%`;
        document.getElementById('remain').innerText = `Â¥${remain.toLocaleString()}`;
        
        document.getElementById('barFill').style.width = `${pct}%`;
        document.getElementById('mascot').style.left = `${pct}%`;
        
        const icons = {'travel':'âœˆï¸','house':'ğŸ ','digital':'ğŸ’»'};
        document.getElementById('mascot').innerText = icons[appData.config.theme] || 'ğŸ’°';
        
        const msgs = pct >= 100 ? "ğŸ‰ ç›®æ ‡è¾¾æˆï¼å¤ªæ£’äº†ï¼" : pct > 50 ? "ğŸš€ å·²ç»è¿‡åŠäº†ï¼Œç»§ç»­åŠ æ²¹ï¼" : "ğŸŒ± åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹";
        document.getElementById('motivate').innerText = msgs;

        renderLogs(); renderGoals(); renderChart();
    }

    function renderLogs() {
        const list = document.getElementById('logList'); list.innerHTML = '';
        [...appData.logs].sort((a,b) => b.timestamp - a.timestamp).slice(0,5).forEach(l => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${new Date(l.timestamp).toLocaleDateString()}</span><span style="color:var(--primary);font-weight:bold">+${l.amount}</span>`;
            list.appendChild(li);
        });
    }

    function renderGoals() {
        const list = document.getElementById('goalsList'); list.innerHTML = '';
        appData.goals.forEach((g, i) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${g.name}</span><span>Â¥${g.cost}</span><button class="secondary" onclick="removeGoal(${i})" style="width:auto;padding:4px 8px;font-size:0.8rem">Ã—</button>`;
            list.appendChild(li);
        });
    }

    function renderChart() {
        const ctx = document.getElementById('growthChart').getContext('2d');
        const sorted = [...appData.logs].sort((a,b) => a.timestamp - b.timestamp);
        const labels = []; const data = []; let acc = 0;
        sorted.forEach(l => {
            acc += Number(l.amount);
            const d = new Date(l.timestamp).toLocaleDateString();
            if(!labels.includes(d)) { labels.push(d); data.push(acc); }
            else { data[data.length-1] = acc; }
        });

        if (chartInstance) chartInstance.destroy();
        const style = getComputedStyle(document.documentElement);
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    data, borderColor: style.getPropertyValue('--primary').trim(),
                    backgroundColor: style.getPropertyValue('--primary').trim()+'20',
                    fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: {display:false} },
                scales: { x: { display: false }, y: { grid: { display: false } } }
            }
        });
    }

    function initTheme() {
        const saved = localStorage.getItem(THEME_KEY) || 'light';
        document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('themeToggleBtn').innerText = saved === 'dark' ? 'ğŸŒ™' : 'ğŸŒ';
        document.getElementById('themeToggleBtn').onclick = () => {
            const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', n);
            localStorage.setItem(THEME_KEY, n);
            document.getElementById('themeToggleBtn').innerText = n === 'dark' ? 'ğŸŒ™' : 'ğŸŒ';
            renderChart();
        };
    }

    function setupEvents() {
        document.getElementById('addDeposit').onclick = () => {
            const v = Number(document.getElementById('depositAmount').value);
            if(v > 0) {
                appData.logs.push({ amount: v, timestamp: Date.now() });
                saveData(); document.getElementById('depositAmount').value = '';
                confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 } });
            }
        };

        ['dailyAmount','startDate','endDate'].forEach(id => {
            document.getElementById(id).addEventListener('input', calcTotal);
        });

        document.getElementById('saveConfig').onclick = () => {
            appData.config.daily = document.getElementById('dailyAmount').value;
            appData.config.target = document.getElementById('targetAmount').value;
            appData.config.start = document.getElementById('startDate').value;
            appData.config.end = document.getElementById('endDate').value;
            appData.config.theme = document.getElementById('theme').value;
            saveData(); alert('è®¾ç½®å·²ä¿å­˜');
        };

        document.getElementById('addGoalBtn').onclick = () => {
            const n = document.getElementById('goalName').value, c = document.getElementById('goalTarget').value;
            if(n && c) { appData.goals.push({name:n, cost:c}); saveData(); document.getElementById('goalName').value=''; document.getElementById('goalTarget').value=''; }
        };

        document.getElementById('resetAll').onclick = () => { if(confirm('ç¡®å®šæ¸…ç©ºï¼Ÿ')) { localStorage.removeItem(APP_KEY); location.reload(); } };
    }

    function calcTotal() {
        const d = document.getElementById('dailyAmount').value, s = new Date(document.getElementById('startDate').value), e = new Date(document.getElementById('endDate').value);
        const h = document.getElementById('calcHint');
        if(d && s && e && e > s) {
            const days = Math.ceil((e-s)/86400000) + 1;
            const t = days * d;
            document.getElementById('targetAmount').value = t;
            h.style.display = 'block'; h.innerHTML = `è‡ªåŠ¨è®¡ç®—: ${days}å¤© Ã— Â¥${d} = <strong>Â¥${t}</strong>`;
        } else h.style.display = 'none';
    }
    window.removeGoal = (i) => { appData.goals.splice(i,1); saveData(); };
</script>
</body>
</html>
